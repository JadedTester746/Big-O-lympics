<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name = "viewport" content "width = device-width, initial-scale = 1">
        <title> Account </title>
        <link rel= "icon" type = "png" href = "OlympicsLogo.png">
        <link rel = "stylesheet" href = "css/style.css">
    </head>
    <body>
        <div class = "title">
            <div class = "row">
                <div class = "left-group" style = "display: flex; align-items: center;">
                    <div class = "titleBOX">
                        <img class = "logo" src = ImageFolder/Logo.png>
                    </div>
                    <div class = "titleBOX">
                        <a href = "index.html"> <span style = "font-size: 250%;color:rgb(10, 100, 160)"> <b>Big-(O)lympics</b> </span> </a>
                        
                    </div>
                </div>

                <div class = "right-group" style = "display: flex; align-items: center; gap:20px;">
                
                    <div class = "titleBOX">
                        <a href = "Account.html"> 
                            <div class = "profile">
                                <div class = "row">
                                    <div class = "image-cropper">
                                        <img src = "ImageFolder/profileIMG.jpg" class = "rounded">;
                                    </div>
                                    <div class = "profileText">
                                        <span style = "color:rgb(0, 0, 0)">  
                                            <p><b><span id="user"></span></b></p>
                                            <p>Tests Completed:<b><span id="completedPackets"></span></b></p>
                                            <p>>D1 Thrower</p>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    
        <hr>
        <div class="name-change-box" style="margin: 20px;">
            <label for="newName">Change display name:</label>
            <input type="text" id="newName" placeholder="Enter new name">
            <button onclick="changeName()">Submit</button>
            <p id="nameChangeStatus" style="color: green;"></p>
        </div>
        
        <h3>Upload Profile Picture</h3>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" name="file" accept="image/*" required>
            <button type="submit">Upload</button>
        </form>
        <img id="preview" src="/profile-pic" class="rounded" onerror="this.src='ImageFolder/default.jpg'" style="margin-top: 10px; width: 100px; border-radius: 50%;">

    </body>
    <script>
        function changeName() {
            const newName = document.getElementById('newName').value.trim();
            if (!newName) {
                alert("Please enter a valid name.");
                return;
            }
    
            fetch(`/namechange?name=${encodeURIComponent(newName)}`, {
                method: "GET",
                credentials: "include"
            })
            .then(res => {
                if (res.ok) {
                    document.getElementById('nameChangeStatus').textContent = "Name updated successfully!";
                    document.getElementById('user').textContent = newName;
                } else {
                    document.getElementById('nameChangeStatus').style.color = "red";
                    document.getElementById('nameChangeStatus').textContent = "Failed to update name.";
                }
            })
            .catch(err => {
                document.getElementById('nameChangeStatus').style.color = "red";
                document.getElementById('nameChangeStatus').textContent = "Error contacting server.";
                console.error(err);
            });
        }
    </script>

    <script>
        document.getElementById("uploadForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(this);
    
            fetch("/uploadProfilePic", {
                method: "POST",
                body: formData,
                credentials: "include"
            }).then(res => {
                if (res.ok) {
                    alert("Upload successful!");
                    document.getElementById("preview").src = "/profile-pic?" + new Date().getTime(); // prevent caching
                } else {
                    alert("Upload failed.");
                }
            });
        });
    </script>
    
</html>